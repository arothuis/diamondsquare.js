(function(){this.DiamondSquare=(function(){a.prototype.defaultSettings={name:0,roughness:2500,smoothness:1,seed:false,size:9,min:0,max:255,prng:false};function a(b){this.settings=this.defaultSettings;if(typeof(b)==="object"){this.setSettings(b)}}a.prototype.setSettings=function(c){for(var b in c){if(this.settings[b]!=="undefined"){this.settings[b]=c[b]}switch(b){case"min":case"max":this.settings.mid=Math.floor((this.settings.min+this.settings.max)/2);break}}if(!this.settings.prng){if(typeof(console)!=="undefined"){console.log("DS: Missing prng function. Not using seed.")}this.settings.seed=false;this.prng=Math.random}else{this.settings.seed=(this.settings.seed!==false)?this.settings.seed:this.randomSeed();this.prng=this.settings.prng(this.settings.seed)}return this};a.prototype.limit=function(c){var b=typeof(c);if(b!=="number"&&c!=parseInt(c,10)){throw"Type error: value '"+c+"' is of type '"+b+"', expected: 'number' || 'integer'"}if(c>this.settings.max){c=this.settings.max}else{if(c<this.settings.min){c=this.settings.min}}return c};a.prototype.randomSeed=function(){return Math.random().toString(36).slice(2)};a.prototype.randomNum=function(c,d){c=c!=null?c:true;d=d!=null?d:0;var e=this.settings.max;var b=this.settings.min;if(c){e++;b--}return this.prng()*(e-b)+b-d};a.prototype.createMap=function(d,c){var f,e;var g=Array();if(c===true){f=d}else{f=Math.pow(2,d)+1}e=new Array(f);for(var b=0;b<f;b++){e[b]=new Array(f);for(var h=0;h<f;h++){e[b][h]=null}}this.settings.dimension=e.length;this.settings.maxKey=e.length-1;this.map=e;return this};a.prototype.displace=function(b){return(Math.floor(this.randomNum(true,this.settings.mid)*(b/this.settings.maxKey*2*this.settings.roughness/1000)))};a.prototype.setPoint=function(b,e,d,c){c=(c!=null)?c:false;d=(d!=null)?this.limit(d):Math.floor(this.randomNum());if(!c){if(this.map[b][e]===null){this.map[b][e]=d}}else{this.map[b][e]=d}return this.map[b][e]};a.prototype.startDisplacement=function(){var d,g,e,c,b,f=this.settings.maxKey;d=this.setPoint(0,0);g=this.setPoint(f,0);e=this.setPoint(f,f);c=this.setPoint(0,f);b=this.setPoint(f/2,f/2,(d+g+e+c)/4);this.setPoint(f/2,f,(c+e+b+b)/4);this.setPoint(f/2,0,(d+g+b+b)/4);this.setPoint(f,f/2,(g+e+b+b)/4);this.setPoint(0,f/2,(d+c+b+b)/4);this.midpointDisplacement(this.settings.maxKey);return this};a.prototype.midpointDisplacement=function(f){var h=f/2,k,c,l,p,b,g,e,n,m,o,d;if(h>1){for(g=h;g<this.settings.dimension;g+=h){for(e=h;e<this.settings.dimension;e+=h){k=this.map[g-h][e-h];c=this.map[g][e-h];l=this.map[g][e];p=this.map[g-h][e];o=h/2;d=h*2;n=g-o;m=e-o;b=this.setPoint(n,m,(k+c+l+p)/4+this.displace(f));if(e-d+o>0){this.setPoint(n,e-h,(k+c+b+this.map[n][e-f+o])/4+this.displace(f))}else{this.setPoint(n,e-h,(k+c+b)/3+this.displace(f))}if(e+o<this.keyDim){this.setPoint(n,e,(p+l+b+this.map[n][e+o])/4+this.displace(f))}else{this.setPoint(n,e,(p+l+b)/3+this.displace(f))}if(g+o<this.keyDim){this.setPoint(g,m,(c+l+b+this.map[g+o][m])/4+this.displace(f))}else{this.setPoint(g,m,(c+l+b)/3+this.displace(f))}if(g-d+o>0){this.setPoint(g-h,m,(k+p+b+this.map[g-f+o][m])/4+this.displace(f))}else{this.setPoint(g-h,m,(k+p+b)/3+this.displace(f))}}}this.midpointDisplacement(h)}return this};a.prototype.smoothen=function(e){var f=0,d=0;e=(e!=null)?e:3;for(var c=0;c<e;c++){for(var b=0;b<this.settings.dimension;b++){for(var g=0;g<this.settings.dimension;g++){if(typeof(this.map[b][g-1])!=="undefined"){f+=this.map[b][g-1];d++}if(typeof(this.map[b+1])!=="undefined"){f+=this.map[b+1][g];d++}if(typeof(this.map[b-1])!=="undefined"){f+=this.map[b-1][g];d++}if(typeof(this.map[b][g+1])!=="undefined"){f+=this.map[b][g+1];d++}this.map[b][g]=f/d;f=0;d=0}}}return this};a.prototype.make=function(){this.createMap(this.settings.size);this.startDisplacement();this.smoothen(this.settings.smoothness);return this};return a})()}).call(this);