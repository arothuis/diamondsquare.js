/*
 * DiamondSquare.js 0.2
 * (c) 2015 A. Rothuis (@arothuis)
 * License: MIT
 */
(function(){this.DiamondSquare=(function(){a.prototype.defaultSettings={roughness:2500,smoothness:2,seed:false,size:9,min:0,max:255,prng:false};a.prototype.callbacks={perPoint:[]};function a(b){this.settings=this.defaultSettings;if(typeof(b)==="object"){this.setSettings(b)}}a.prototype.setSettings=function(c){for(var b in c){if(this.settings[b]!=="undefined"){this.settings[b]=c[b]}}this.settings.size=this.settings.size<<0;this.settings.mid=((this.settings.min+this.settings.max)/2)<<0;if(!this.settings.prng){if(typeof(console)!=="undefined"){console.log("DS: Missing prng function. Not using seed.")}this.settings.seed=false;this.prng=Math.random}else{this.settings.seed=(this.settings.seed!==false)?this.settings.seed:this.randomSeed();this.prng=this.settings.prng(this.settings.seed)}return this};a.prototype.limit=function(c){var b=typeof(c);if(b!=="number"&&c!=parseInt(c,10)){throw"Type error: value '"+c+"' is of type '"+b+"', expected: 'number' || 'integer'"}if(c>this.settings.max){c=this.settings.max}else{if(c<this.settings.min){c=this.settings.min}}return c};a.prototype.randomSeed=function(){return Math.random().toString(36).slice(2)};a.prototype.randomNum=function(c,d){c=c!=null?c:true;d=d!=null?d:0;var e=this.settings.max;var b=this.settings.min;if(c){e++;b--}return this.prng()*(e-b)+b-d};a.prototype.getSizeFactor=function(c){var b=Math.log(c.length-1)/Math.log(2);return b};a.prototype.addCallbackPerPoint=function(c){var c=(typeof(c)!=="array")?[c]:c;for(var b=0;b<c.length;b++){this.callbacks.perPoint.push(c[b])}return this};a.prototype.removeAllCallbacksPerPoint=function(){this.callbacks.perPoint=[];return this};a.prototype.runCallbacks=function(f,b,g,d){if(typeof(this.callbacks[f])!=="undefined"){for(var c=0;c<this.callbacks[f].length;c++){var e=this.callbacks[f][c](b,g,d);if(typeof(e)!=="number"){console.log("Warning: Your callback should be returning a number. Ignoring your callback.")}else{d=e}}}return d};a.prototype.createMap=function(d,c){d=(d!=null)?d:this.settings.size;var f,e;var g=Array();if(c===true){f=d}else{f=Math.pow(2,d)+1}e=new Array(f);for(var b=0;b<f;b++){e[b]=new Array(f);for(var h=0;h<f;h++){e[b][h]=null}}this.settings.dimension=e.length;this.settings.maxKey=e.length-1;this.map=e;return this};a.prototype.displace=function(b){return(Math.floor(this.randomNum(true,this.settings.mid)*(b/this.settings.maxKey*2*this.settings.roughness/1000)))};a.prototype.setRowsOrColumns=function(c,f,e){e=(e!=null)?e:true;var i;for(var d in c){if(c.hasOwnProperty(d)){var g=c[d];switch(d.toLowerCase()){case"first":i=0;break;case"last":i=this.settings.maxKey;break;case"mid":case"center":i=this.settings.maxKey/2;break;default:i=d;break}if(i<=this.settings.maxKey&&i>=0){if(f.toLowerCase()==="row"){for(var b=0;b<=this.settings.maxKey;b++){this.setPoint(b,i,g,e)}}else{for(var h=0;h<=this.settings.maxKey;h++){this.setPoint(i,h,g,e)}}}}}return this};a.prototype.setColumns=function(b,c){this.setRowsOrColumns(b,"columns",c);return this};a.prototype.setRows=function(c,b){this.setRowsOrColumns(c,"row",b);return this};a.prototype.setPoints=function(e,c){c=(c!=null)?c:true;for(var b in e){if(e.hasOwnProperty(b)){for(var f in e[b]){if(e[b].hasOwnProperty(f)){var d=e[b][f];if(b<=this.settings.maxKey&&b>=0&&f<=this.settings.maxKey&&f>=0){this.setPoint(b,f,d,c)}}}}}return this};a.prototype.setNamedPoints=function(b,d){d=(d!=null)?d:true;var f=this.settings.maxKey;for(var c in b){if(b.hasOwnProperty(c)){var e=b[c];switch(c.toLowerCase()){case"n":this.setPoint(f/2,0,e,d);break;case"ne":this.setPoint(f,0,e,d);break;case"e":this.setPoint(f,f/2,e,d);break;case"se":this.setPoint(f,f,e,d);break;case"s":this.setPoint(f/2,f,e,d);break;case"sw":this.setPoint(0,f,e,d);break;case"w":this.setPoint(0,f/2,e,d);break;case"nw":this.setPoint(0,0,e,d);break;case"center":case"mid":this.setPoint(f/2,f/2,e,d);break}}}return this};a.prototype.setPoint=function(b,e,d,c){c=(c!=null)?c:false;d=(d!=null)?this.limit(d):this.randomNum();d=d<<0;if(!c){if(this.map[b][e]===null){this.map[b][e]=this.runCallbacks("perPoint",b,e,d)}}else{this.map[b][e]=this.runCallbacks("perPoint",b,e,d)}return this.map[b][e]};a.prototype.startDisplacement=function(){var d,g,e,c,b,f=this.settings.maxKey;d=this.setPoint(0,0);g=this.setPoint(f,0);e=this.setPoint(f,f);c=this.setPoint(0,f);b=this.setPoint(f/2,f/2,(d+g+e+c)/4);this.setPoint(f/2,f,(c+e+b+b)/4);this.setPoint(f/2,0,(d+g+b+b)/4);this.setPoint(f,f/2,(g+e+b+b)/4);this.setPoint(0,f/2,(d+c+b+b)/4);this.midpointDisplacement(this.settings.maxKey);return this};a.prototype.midpointDisplacement=function(f){var h=f/2,k,c,l,p,b,g,e,n,m,o,d;if(h>1){for(g=h;g<this.settings.dimension;g+=h){for(e=h;e<this.settings.dimension;e+=h){k=this.map[g-h][e-h];c=this.map[g][e-h];l=this.map[g][e];p=this.map[g-h][e];o=h/2;d=h*2;n=g-o;m=e-o;b=this.setPoint(n,m,(k+c+l+p)/4+this.displace(f));if(e-d+o>0){this.setPoint(n,e-h,(k+c+b+this.map[n][e-f+o])/4+this.displace(f))}else{this.setPoint(n,e-h,(k+c+b)/3+this.displace(f))}if(e+o<this.keyDim){this.setPoint(n,e,(p+l+b+this.map[n][e+o])/4+this.displace(f))}else{this.setPoint(n,e,(p+l+b)/3+this.displace(f))}if(g+o<this.keyDim){this.setPoint(g,m,(c+l+b+this.map[g+o][m])/4+this.displace(f))}else{this.setPoint(g,m,(c+l+b)/3+this.displace(f))}if(g-d+o>0){this.setPoint(g-h,m,(k+p+b+this.map[g-f+o][m])/4+this.displace(f))}else{this.setPoint(g-h,m,(k+p+b)/3+this.displace(f))}}}this.midpointDisplacement(h)}return this};a.prototype.smoothen=function(e){var f=0,d=0;e=(e!=null)?e:3;for(var c=0;c<e;c++){for(var b=0;b<this.settings.dimension;b++){for(var g=0;g<this.settings.dimension;g++){this.smoothenPoint(b,g)}}}return this};a.prototype.smoothenPoint=function(b,e){var d=0,c=0;if(typeof(this.map[b][e-1])!=="undefined"){d+=this.map[b][e-1];c++}if(typeof(this.map[b+1])!=="undefined"){d+=this.map[b+1][e];c++}if(typeof(this.map[b-1])!=="undefined"){d+=this.map[b-1][e];c++}if(typeof(this.map[b][e+1])!=="undefined"){d+=this.map[b][e+1];c++}if(this.map[b][e]!==null){d+=this.map[b][e];c++}this.setPoint(b,e,d/c,true)};a.prototype.make=function(){if(typeof this.map!=="undefined"){this.startDisplacement();this.smoothen(this.settings.smoothness)}else{throw"No map has been defined yet. Please insert or create a map first."}return this.map};return a})()}).call(this);
